# NutriTracker â€” Sessao 2025-09-27 (resumo + proximo passo)

## Estado atual (ok)
- Worker Cloudflare online (hardened):
  - Rotas: GET /, /health, /version; POST /calcular_metas, /planejar_jejum, /vision/analyze_food (alias /analisar_foto)
  - Seguranca: CORS por ALLOWED_ORIGINS; X-App-Token obrigatorio (APP_TOKEN) em todas as chamadas; Turnstile exigido apenas no Web
  - Rate limit: in-memory + KV (binding `RATELIMIT`), respeita `VISION_RATE_LIMIT`
- Variaveis/Bindings relevantes no Worker (Production):
  - Secrets: OPENAI_API_KEY, APP_TOKEN, TURNSTILE_SECRET
  - Text: ALLOWED_ORIGINS, OPENAI_MODEL=gpt-4o-mini, VISION_PROVIDER=openai, VISION_RATE_LIMIT=20, TURNSTILE_REQUIRED=1
  - KV Namespace: `RATELIMIT` -> namespace Workers KV
- URL base (workers.dev):
  - https://nutritracker-worker.alexandretmoraes110.workers.dev

## O que foi feito hoje
- App apontado para o Worker de visao:
  - `env.json`: `COACH_VISION_BASE_URL` definido para o workers.dev
  - `COACH_APP_TOKEN` lido de `env.json` e enviado como `X-App-Token`
- Normalizacao de payload do Worker (pt-BR -> formato interno do app):
  - Mapeamento por item: `nome`->`name`, `porcao_g`->`portion_size` ("X g"), `calorias_kcal`->`calories`,
    `proteina_g`->`protein`, `carbo_g`->`carbs`, `gordura_g`->`fat`, `fibra_g`->`fiber`, `acucar_g`->`sugar`, `confianca`->`confidence`
  - Arquivo: `lib/services/coach_api_service.dart:183` e `lib/services/coach_api_service.dart:243`
- Turnstile nao quebra o build mobile (Android/iOS):
  - Export condicional evita `dart:js` no mobile
  - Arquivos:
    - `lib/services/turnstile_service.dart:1`
    - `lib/services/turnstile/turnstile_stub.dart:1`
    - `lib/services/turnstile/turnstile_web.dart:1`
- Problema observado: celular dizia "alimento nao reconhecido" pois o token do app nao batia com o APP_TOKEN do Worker (401).

## Passo-a-passo para amanha
1) Sincronizar o APP_TOKEN
   - Cloudflare -> Workers & Pages -> `nutritracker-worker` -> Settings -> Variables -> Secrets
     - Definir/rotacionar `APP_TOKEN` (64 hex). Ex.: `<APP_TOKEN_AQUI>`
     - Deploy/Implantar
2) Atualizar o app
   - Arquivo: `env.json`
     - Setar `"COACH_APP_TOKEN": "<APP_TOKEN_AQUI>"` (exatamente igual ao do Worker)
3) Reinstalar no celular
   - `flutter clean && flutter pub get && flutter run`
4) Teste de saude do Worker (valida token)
   - `curl -i -H "X-App-Token: <APP_TOKEN_AQUI>" https://nutritracker-worker.alexandretmoraes110.workers.dev/health`
   - Esperado: `200 ok`
5) Teste de visao no celular
   - Tirar foto clara (boa luz, alimento grande no quadro) e verificar itens detectados com macros

## Comandos rapidos (substitua BASE/TOKEN)
- Saude com token:
  - `BASE=https://nutritracker-worker.alexandretmoraes110.workers.dev`
  - `curl -i -H "X-App-Token: $TOKEN" "$BASE/health"`
- Metas:
  - `curl -s -X POST "$BASE/calcular_metas" -H 'content-type: application/json' -H "X-App-Token: $TOKEN" -d '{"sexo":"m","idade":32,"peso_kg":78,"altura_cm":178,"nivel_atividade":"moderado","objetivo":"perda"}'`
- Visao (base64, Git Bash):
  - `IMG='https://images.unsplash.com/photo-1550547660-d9450f859349?w=256&q=60&auto=format&fit=crop'`
  - `B64=$(curl -fsSL "$IMG" | base64 -w0)`
  - `curl -s -X POST "$BASE/vision/analyze_food" -H 'content-type: application/json' -H "X-App-Token: $TOKEN" --data-binary "{\"image_base64\":\"$B64\"}"`

## Dicas de diagnostico
- 401 unauthorized -> token do app diferente do APP_TOKEN do Worker
- 403 turnstile_* (somente Web) -> widget/domains/ALLOWED_ORIGINS; no mobile nao usa Turnstile
- 413 image_too_large -> imagem muito grande; app ja comprime (768px/85%)
- 429 rate_limited -> aguarde ~60s; o app re-tenta 1x respeitando Retry-After
- 502 OpenAI -> conferir `OPENAI_API_KEY` no Worker

## Locais de codigo (referencias)
- Worker (manter como fonte da verdade no repo depois): `server/cloudflare/worker.js`
- Normalizacao do payload:
  - `lib/services/coach_api_service.dart:183`
  - `lib/services/coach_api_service.dart:243`
- Turnstile (conditional export):
  - `lib/services/turnstile_service.dart:1`
  - `lib/services/turnstile/turnstile_stub.dart:1`
  - `lib/services/turnstile/turnstile_web.dart:1`
- Config do app:
  - `env.json` (COACH_VISION_BASE_URL, COACH_APP_TOKEN)

## Observacao de seguranca
- Nao commitar segredos reais (APP_TOKEN/OPENAI_API_KEY). Use placeholders em arquivos versionados e defina segredos no painel do Cloudflare.

